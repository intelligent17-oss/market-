<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intelligent Marketplace</title>
<style>
body { font-family: Arial,sans-serif; margin:0; padding:20px; background:#f5f5f5; }
.container { max-width:900px; margin:auto; }
h2 { text-align:center; }
.product { background:#fff; padding:15px; margin:15px 0; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.05); display:flex; gap:15px; align-items:flex-start; }
.product img { max-width:150px; border-radius:6px; margin-bottom:5px; }
.product-details { flex:1; }
.product h3 { margin:0 0 5px 0; }
.product p { margin:5px 0; }
.button { padding:10px 15px; margin-top:10px; background:#007bff; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:700; }
#buyModal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
#buyModal .modal-content { background:#fff; padding:20px; border-radius:10px; max-width:500px; width:100%; }
#buyModal input { width:100%; padding:10px; margin:10px 0; border-radius:6px; border:1px solid #ccc; }
.status { padding:10px; margin:10px 0; border-radius:6px; font-weight:600; display:none; }
.loading { background:#fff3cd; color:#856404; }
.success { background:#d4edda; color:#155724; }
.error { background:#f8d7da; color:#721c24; }
</style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div class="container">
<h2>Intelligent Marketplace</h2>
<div id="products"></div>
<div id="status" class="status"></div>
</div>

<!-- Buy Modal -->
<div id="buyModal">
<div class="modal-content">
<h3>Complete Your Payment</h3>
<p id="paymentInfo"></p>
<label>Upload Payment Screenshot:</label>
<input type="file" id="paymentScreenshot" accept="image/*">
<label>Contact Info (Whatsapp/Telegram/Email):</label>
<input type="text" id="buyerContact" placeholder="Enter your contact info">
<button id="submitPayment" class="button">Submit Payment</button>
<button id="closeModal" class="button" style="background:#dc3545;">Cancel</button>
</div>
</div>

<!-- Monetag SDK -->
<script src="//libtl.com/sdk.js" data-zone="9830606" data-sdk="show_9830606"></script>

<script>
// ===== CONFIG =====
const ADMIN_ID = "8140042906";  // Admin Telegram ID
const BOT_TOKEN = "7514817340:AAHUpE5ZPEUZkkM4rq4smoV_nzWfmwWBVGc";
const PAYMENT_NG = "9114301708 - Opay - olatunji Ayomide Abdumalik";
const PAYMENT_BTC = "bc1qxhyddpkgvdc68tj9xk5gf5k2vnxmnfy4xrwwr4";

// Telegram user info
const tg = window.Telegram.WebApp;
tg.expand();
const TELEGRAM_USER_ID = tg.initDataUnsafe?.user?.id || "unknown";
const TELEGRAM_USER_NAME = tg.initDataUnsafe?.user?.first_name || "Buyer";

// ===== PRODUCTS ARRAY =====
const productsData = [
  {
    id: "P001",
    name: "Instagram Account",
    description: "High-quality IG account with 10k followers.",
    price: "â‚¦5000",
    images: ["https://via.placeholder.com/150"],
    sellerId: "123456789",
    sellerWhatsapp: "+2348012345678"
  },
  {
    id: "P002",
    name: "Twitter Account",
    description: "Active Twitter account with 5k followers.",
    price: "$50",
    images: ["https://via.placeholder.com/150"],
    sellerId: "987654321",
    sellerWhatsapp: "+2348098765432"
  }
];

// ===== FUNCTIONS =====
const productsContainer = document.getElementById("products");
const buyModal = document.getElementById("buyModal");
const paymentInfoEl = document.getElementById("paymentInfo");
const screenshotInput = document.getElementById("paymentScreenshot");
const buyerContactInput = document.getElementById("buyerContact");
const statusBox = document.getElementById("status");
let currentProduct = null;

function showStatus(type,msg,autoHide=0){
  statusBox.className = "status "+type;
  statusBox.textContent = msg;
  statusBox.style.display="block";
  if(autoHide) setTimeout(()=>{statusBox.style.display="none"}, autoHide);
}

// Render products
function renderProducts(){
  productsContainer.innerHTML="";
  productsData.forEach(prod=>{
    const div = document.createElement("div");
    div.className="product";
    div.innerHTML=`
      <div>${prod.images.map(img=>`<img src="${img}" alt="${prod.name}">`).join('')}</div>
      <div class="product-details">
        <h3>${prod.name}</h3>
        <p>${prod.description}</p>
        <p>Price: ${prod.price}</p>
        <p>Product ID: ${prod.id}</p>
        <p>Seller ID: ${prod.sellerId}</p>
        <button class="button buyBtn" data-id="${prod.id}">Buy Product</button>
      </div>
    `;
    productsContainer.appendChild(div);
  });

  document.querySelectorAll(".buyBtn").forEach(btn=>{
    btn.addEventListener("click",()=>{openBuyModal(btn.dataset.id);});
  });
}

// Open buy modal
function openBuyModal(productId){
  currentProduct = productsData.find(p=>p.id===productId);
  if(!currentProduct) return;
  paymentInfoEl.innerHTML=`
    <b>Pay Nigeria:</b> ${PAYMENT_NG}<br>
    <b>Pay Foreign:</b> ${PAYMENT_BTC}<br><br>
    After payment, upload screenshot and enter your contact info.
  `;
  buyerContactInput.value="";
  screenshotInput.value="";
  buyModal.style.display="flex";
}

document.getElementById("closeModal").addEventListener("click",()=>{buyModal.style.display="none";});

// Submit payment
document.getElementById("submitPayment").addEventListener("click",async ()=>{
  const file = screenshotInput.files[0];
  const contact = buyerContactInput.value.trim();
  if(!file) return showStatus("error","Please upload screenshot",3000);
  if(!contact) return showStatus("error","Please enter your contact info",3000);
  if(!currentProduct) return;
  showStatus("loading","Submitting payment...");

  try{
    const form = new FormData();
    form.append("chat_id",ADMIN_ID);
    form.append("photo",file);
    form.append("caption",
      `ðŸ“Œ New Pending Payment\n`+
      `Product: ${currentProduct.name} (${currentProduct.id})\n`+
      `Price: ${currentProduct.price}\n`+
      `Seller ID: ${currentProduct.sellerId}\n`+
      `Seller Whatsapp: ${currentProduct.sellerWhatsapp}\n`+
      `Buyer ID: ${TELEGRAM_USER_ID}\n`+
      `Buyer Contact: ${contact}`
    );
    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`,{method:"POST",body:form});

    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        chat_id:TELEGRAM_USER_ID,
        text:`âœ… Payment submitted!\nAdmin will review your payment to purchase "${currentProduct.name}" (${currentProduct.id}) within some hours (up to 12h).\nPrice: ${currentProduct.price}\nPlease be patient.\nNeed help? WhatsApp: +2348121697423`
      })
    });

    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        chat_id:currentProduct.sellerId,
        text:`ðŸ“Œ New Purchase Submission\nProduct: ${currentProduct.name}\nProduct ID: ${currentProduct.id}\nPrice: ${currentProduct.price}\nPlease wait while admin reviews.\nNeed help? WhatsApp: +2348121697423`
      })
    });

    showStatus("success","Payment submitted! Admin will review.",5000);
    buyModal.style.display="none";
  }catch(err){
    showStatus("error","Failed to submit payment",3000);
    console.error(err);
  }
});

// Initialize products
renderProducts();

// ===== MONETAG ADS =====
function showAd() {
    if (typeof show_9830606 === "function") {
        show_9830606();
    } else {
        console.log("Monetag function not ready yet");
    }
}

window.addEventListener("load", () => {
    setTimeout(() => {
        showAd();
        setInterval(showAd, 30000); // repeat every 30s
    }, 5000); // first ad after 5s
});
</script>
</body>
</html>