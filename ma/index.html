<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sell Product ‚Äî Intelligent Marketplace</title>

<!-- Telegram SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg:#f7f7f7;
    --text:#111;
    --card:#fff;
    --accent:#000;
    --success:#1E8A3C;
    --error:#C92A2A;
    --warning:#D97706;
  }
  body.dark{
    --bg:#0f1113;
    --text:#e6eef8;
    --card:#151719;
    --accent:#fff;
  }
  body{ font-family: Arial, Helvetica, sans-serif; padding:20px; background:var(--bg); color:var(--text); transition: background .25s,color .25s; margin-top:50px;}
  h2,h3{ margin:.25rem 0 .75rem 0; }
  input,textarea,select,button{ width:100%; padding:10px; margin:6px 0; background:var(--card); color:var(--text); border:1px solid #999; border-radius:8px; box-sizing:border-box; }
  label{ font-weight:600; margin-top:8px; display:block; }
  button{ cursor:pointer; border:none; background:var(--accent); color:var(--card); }
  button:disabled{ background:#777; cursor:not-allowed; }
  .hidden{ display:none; }
  .nav{ display:flex; gap:10px; margin-top:18px; }
  .nav button{ flex:1; }
  a{ color:blue; text-decoration:underline; }
  #userInfo img{ border-radius:50%; width:60px; height:60px; object-fit:cover; display:block; margin-bottom:6px; }
  #themeToggle{ position:fixed;  right:0px; top:-10px; background:var(--card); color:var(--text); padding:8px 12px; border-radius:10px; z-index:999; border:1px solid #888; height:60px; font-size:20px;}
  #waBtn{ padding:14px; font-size:18px; font-weight:700; background:#045405; color:#fff; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.15); }
  .notice{ background:#fff4ce; padding:10px; margin-top:6px; border-left:4px solid #ffbb00; border-radius:6px; font-size:14px; color:#8a6d00; font-weight:bold; }
  /* centered popup */
  .popupOverlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); z-index:2000; }
  .popup{ max-width:460px; width:90%; background:var(--card); color:var(--text); border-radius:12px; padding:22px; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.35); }
  .popup .title{ font-size:20px; font-weight:700; margin-bottom:8px; }
  .popup .msg{ font-size:16px; margin-bottom:10px; }
  .popup .ok{ margin-top:8px; padding:10px 14px; border-radius:8px; cursor:pointer; border:none; }
  .popup.success{ border-top:6px solid var(--success); }
  .popup.error{ border-top:6px solid var(--error); }
  .required{ color:var(--error); margin-left:6px; font-weight:700; }
  /* status inline (for small screen) */
  #statusMsg{ display:block; margin-top:10px; font-weight:700; font-size:15px; }
  h2 {
    margin-top: 50px;
  }
  /* Image preview container */
#imagePreviewContainer {
  width: 100%;
  max-height: 250px;
  overflow-y: auto;
  overflow-x: hidden;
  border: 1px solid #ccc;
  border-radius: 10px;
  margin-top: 10px;
  background: #fff;
  padding: 6px;
}

#imagePreview {
  width: 100%;
  height: auto;
  object-fit: contain;
  display: block;
}
</style>
</head>
<body>
<!-- WALLET QUICK ACCESS (MINIMAL BLACK & WHITE) -->
<div id="walletBtn">
  <span class="wallet-icon"></span>
  <span class="wallet-text">Wallet</span>
</div>

<script>
/* =====================================
   BLACK & WHITE WALLET UI (SELF CONTAINED)
===================================== */
(function () {
  const style = document.createElement("style");
  style.innerHTML = `
    #walletBtn {
      position: fixed;
      top: 14px;
      right: 14px;
      background: #000;
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      z-index: 100000;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      user-select: none;
    }

    #walletBtn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 22px rgba(0,0,0,0.45);
    }

    #walletBtn:active {
      transform: scale(0.96);
    }

    /* ICON */
    .wallet-icon {
      width: 18px;
      height: 14px;
      border: 2px solid #fff;
      border-radius: 3px;
      position: relative;
    }

    .wallet-icon::before {
      content: "";
      position: absolute;
      right: -5px;
      top: 3px;
      width: 6px;
      height: 6px;
      border: 2px solid #fff;
      border-left: none;
      border-radius: 0 3px 3px 0;
    }

    /* DARK MODE SUPPORT (WHITE BUTTON) */
    body.dark #walletBtn {
      background: #fff;
      color: #000;
      box-shadow: 0 6px 18px rgba(255,255,255,0.15);
    }

    body.dark .wallet-icon {
      border-color: #000;
    }

    body.dark .wallet-icon::before {
      border-color: #000;
    }
  `;
  document.head.appendChild(style);

  document.getElementById("walletBtn").onclick = () => {
    window.location.href = "wa.html";
  };
})();
</script>
<button id="themeToggle">üåô Dark Mode</button>
<h2>Step 1: Share our bot link on WhatsApp to start selling any product</h2>
<p>Repost the bot link on your WhatsApp status and at least 5 groups/people. <b> when you've done posting come back to this bot, and you will be able to sell account for free, ‚úÖ you will not pay any money </b></p>

<button id="waBtn">Repost on WhatsApp</button>
  <p>Please make sure you <a href="https://t.me/intelligentmarketbot?start=ar1810544353" target="_blank">start our bot </a>  to receive notification if there is buyers, or any others notification <a href="https://t.me/intelligentmarketbot?start=ar1810544353" target="_blank">start bot</a></p>
<div class="notice">
  ‚ö†Ô∏è We show multiple ads in this webapp. Please be patient. Blocking ads may break some buttons.
  <p>Please make sure you start our bot to receive notification if there is buyers, or any others notification <a href="https://t.me/intelligentmarketbot?start=ar1810544353" target="_blank">start bot</a></p>
</div>

<!-- FORM -->
<div id="formContainer" class="hidden" aria-hidden="true">

  <div id="userInfo" style="margin-top:18px;">
    <h3>Logged in as:</h3>
    <img id="profilePic" src="https://via.placeholder.com/60" alt="Profile picture">
    <p id="fullName"></p>
    <p id="username"></p>
    <p id="userId"></p>
  </div>

  <h2>Step 2: Sell your product</h2>

  <form id="sellForm" novalidate>
    <label>Product Name <span class="required">*</span></label>
    <input type="text" id="productName" required placeholder="e.g. Instagram account - 10k followers">

    <label>Upload Local Image (preview only)</label>
    <input type="file" id="localImage" accept="image/*">
<!-- SCROLLABLE IMAGE PREVIEW -->
<div id="imagePreviewContainer">
  <img id="imagePreview" src="" alt="Preview">
</div>
    <div class="notice" style="margin-bottom:8px;">
      ‚ö†Ô∏è Host your image on <a href="https://imgbb.com/" target="_blank" rel="noopener">imgbb</a> or it won't display. (Hosted Image URL is required.)
    </div>

    <label>Hosted Image URL <span class="required">*</span></label>
    <input type="url" id="hostedImage" required placeholder="https://i.imgur.com/....">

    <label>Product URL <span class="required">*</span></label>
    <input type="url" id="productUrl" required placeholder="https://...">

    <label>Price <span class="required">*</span></label>
    <input type="number" id="productPrice" required placeholder="Amount">

    <label>Currency <span class="required">*</span></label>
    <select id="currency" required>
      <option value="NGN">NGN</option>
      <option value="USD">USD</option>
    </select>

    <label>Description <span class="required">*</span></label>
    <textarea id="description" required rows="4" placeholder="Describe the product"></textarea>

    <label>Contact Info <span class="required">*</span></label>
    <input type="text" id="contactInfo" required placeholder="Whatsapp: +234...">

    <button id="submitBtn" type="button">Submit Product</button>

    <p id="statusMsg" class="hidden" role="status" aria-live="polite"></p>
  </form>
</div>

<div class="nav" style="margin-top:14px;">
  <button id="reloadBtn">Sell Account</button>
  <button id="marketBtn">Marketplace</button>
</div>

<!-- Monetag SDK -->
<script src="//libtl.com/sdk.js" data-zone="9830606" data-sdk="show_9830606"></script>

<!-- Popup container (created dynamically by JS) -->

<script>
/* ----- THEME ----- */
const themeToggle = document.getElementById('themeToggle');
let savedTheme = localStorage.getItem('theme');
function applyTheme(t){
  if(t === 'dark'){ document.body.classList.add('dark'); themeToggle.textContent = '‚òÄ Light Mode'; }
  else { document.body.classList.remove('dark'); themeToggle.textContent = 'üåô Dark Mode'; }
}
applyTheme(savedTheme || 'light');
themeToggle.onclick = () => {
  const isDark = document.body.classList.toggle('dark');
  applyTheme(isDark ? 'dark' : 'light');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
};

/* ----- TELEGRAM WEBAPP ----- */
const tg = window.Telegram?.WebApp;
if(tg){ tg.expand(); Telegram.WebApp.ready(); }
const tgUser = (tg && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) ? Telegram.WebApp.initDataUnsafe.user : { first_name:'Guest', id:0 };

/* BOT CONFIG - set your real BOT_TOKEN and ADMIN_ID */
const BOT_TOKEN = "7514817340:AAHUpE5ZPEUZkkM4rq4smoV_nzWfmwWBVGc";
const ADMIN_ID = "6976365864";

/* WHATSAPP LINK */
const WHATSAPP_LINK = "https://wa.me/?text=*Hello!%20guy's*%20%F0%9F%8C%9F%0A%F0%9F%8E%89%20*Looking%20for%20marketplace%20where%20you%20can%20sell%20your%20log's*%20%0A%F0%9F%92%A0%20*Connect%20with%20real%20buyer's%20and%20seller's%20with%20escrow%20trading*%20%0A%20*Follow%20this%20link%20to%20telegram%20now%20to%20get%20started%20%F0%9F%91%87%F0%9F%91%87*%20%0A%20*https%3A%2F%2Ft.me%2Fintelligentmarketbot%3Fstart%3Dar1810544353*";

/* DOM */
const waBtn = document.getElementById('waBtn');
const formContainer = document.getElementById('formContainer');
const submitBtn = document.getElementById('submitBtn');
const statusMsg = document.getElementById('statusMsg');
const sellForm = document.getElementById('sellForm');
const localImage = document.getElementById('localImage');
const hostedImage = document.getElementById('hostedImage');
const productName = document.getElementById('productName');
const productUrl = document.getElementById('productUrl');
const productPrice = document.getElementById('productPrice');
const currencyEl = document.getElementById('currency');
const description = document.getElementById('description');
const contactInfo = document.getElementById('contactInfo');

document.getElementById('fullName').textContent = (tgUser.first_name || '') + (tgUser.last_name ? ' ' + tgUser.last_name : '');
document.getElementById('username').textContent = tgUser.username ? '@' + tgUser.username : '';
document.getElementById('userId').textContent = 'Telegram ID: ' + (tgUser.id || 'N/A');
if(tgUser.photo_url) document.getElementById('profilePic').src = tgUser.photo_url;

/* Persist form inputs in sessionStorage */
Array.from(sellForm.elements).forEach(el => {
  if(!el.id) return;
  // restore
  const saved = sessionStorage.getItem(el.id);
  if(saved) el.value = saved;
  el.addEventListener('input', () => sessionStorage.setItem(el.id, el.value));
});

/* Keep "shared" flag persisted so form remains open if user returns */
function setSharedFlag(){
  sessionStorage.setItem('botShared', '1');
  sessionStorage.setItem('formOpen', '1');
}
function hasSharedFlag(){ return sessionStorage.getItem('botShared') === '1'; }
function openForm(){
  formContainer.classList.remove('hidden');
  formContainer.setAttribute('aria-hidden', 'false');
  sessionStorage.setItem('formOpen','1');
}
function closeForm(){
  formContainer.classList.add('hidden');
  formContainer.setAttribute('aria-hidden', 'true');
  sessionStorage.removeItem('formOpen');
}

/* If form was previously opened, keep it open */
if(sessionStorage.getItem('formOpen') === '1'){
  openForm();
}

/* WHATSAPP BUTTON: open link and mark shared */
waBtn.addEventListener('click', () => {
  // show ad
  safeShowAd();

  // open WhatsApp share window
  window.open(WHATSAPP_LINK, '_blank', 'noopener');

  // save share flag
  setSharedFlag();
  openForm();

  // SCROLL FORM UP SO USER SEES IT
  formContainer.scrollIntoView({ behavior: "smooth", block: "start" });

  // thank you popup
  showPopup('Thank you ‚Äî please complete the form below.', 'success', false);
});

/* Show ad whenever any button is clicked (to match requirement) */
document.querySelectorAll('button').forEach(b => {
  b.addEventListener('click', () => {
    // small debounce so clicks in quick succession don't spam
    safeShowAd();
  });
});

/* Local image preview (scrollable & responsive) */
localImage.addEventListener('change', () => {
  const file = localImage.files?.[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    document.getElementById("imagePreview").src = reader.result;
  };
  reader.readAsDataURL(file);
});

/* Status helper */
function setStatus(text,type){
  statusMsg.textContent = text;
  statusMsg.classList.remove('hidden');
  statusMsg.style.color = (type === 'success') ? 'var(--success)' : (type === 'error') ? 'var(--error)' : 'var(--warning)';
}

/* POPUP CREATION: center modal, required close button. If 'sticky' true, user must click to close; else it auto-dismisses after timeout. */
let popupTimeoutRef = null;
function showPopup(message, type='success', sticky=false, timeout=5000){
  // message: string (can be HTML)
  // type: 'success'|'error'|null
  // sticky: if true user must click OK to close
  // timeout: milliseconds to auto-close if not sticky

  // remove existing
  const existing = document.getElementById('globalPopupOverlay');
  if(existing) existing.remove();
  if(popupTimeoutRef){ clearTimeout(popupTimeoutRef); popupTimeoutRef = null; }

  const overlay = document.createElement('div');
  overlay.className = 'popupOverlay';
  overlay.id = 'globalPopupOverlay';

  const popup = document.createElement('div');
  popup.className = 'popup';
  if(type === 'success') popup.classList.add('success');
  if(type === 'error') popup.classList.add('error');

  const title = document.createElement('div');
  title.className = 'title';
  title.innerHTML = (type === 'success') ? 'Success' : (type === 'error') ? 'Error' : 'Notice';

  const msg = document.createElement('div');
  msg.className = 'msg';
  msg.innerHTML = message;

  const ok = document.createElement('button');
  ok.className = 'ok';
  ok.textContent = sticky ? 'Close' : 'OK';

  ok.onclick = () => { overlay.remove(); };

  popup.appendChild(title);
  popup.appendChild(msg);
  popup.appendChild(ok);
  overlay.appendChild(popup);
  document.body.appendChild(overlay);

  if(!sticky){
    popupTimeoutRef = setTimeout(()=> {
      try{ overlay.remove(); } catch(e){}
      popupTimeoutRef = null;
    }, timeout);
  }
}

/* VALIDATION BEFORE SUBMIT - all fields required (hostedImage required) */
function validateForm(){
  const missing = [];
  if(!productName.value.trim()) missing.push('Product Name');
  if(!hostedImage.value.trim()) missing.push('Hosted Image URL');
  if(!productUrl.value.trim()) missing.push('Product URL');
  if(!productPrice.value.trim()) missing.push('Price');
  if(!currencyEl.value.trim()) missing.push('Currency');
  if(!description.value.trim()) missing.push('Description');
  if(!contactInfo.value.trim()) missing.push('Contact Info');

  return missing;
}

/* SEND POPUP + status visual on submit result */
function handleSubmitSuccess(productId){
  setStatus(`‚úÖ Submitted! Product ID: ${productId}`, 'success');
  showPopup(`Product submitted successfully!<br>Product ID: <strong>${productId}</strong>`, 'success', true);
  // clear storage and form fields
  sessionStorage.removeItem('formOpen');
  sessionStorage.removeItem('botShared');
  sessionStorage.clear();
  sellForm.reset();
}
function handleSubmitFailure(msg){
  setStatus(`‚ùå Submission failed: ${msg}`, 'error');
  showPopup(`Submission failed: ${msg}`, 'error', true);
}

/* TELEGRAM MESSAGE SENDING (send to admin and notify seller) */
function sendTelegramMessages(adminText, sellerText){
  // send to admin first then to seller (return promise)
  const send = (chat_id, text) => fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ chat_id: String(chat_id), text, parse_mode: 'HTML' })
  }).then(r => r.json());

  return send(ADMIN_ID, adminText).then(adminRes => {
    if(!adminRes || !adminRes.ok) return Promise.reject(new Error('Failed to notify admin.'));
    // notify seller (if they have an id)
    if(tgUser && tgUser.id){
      return send(tgUser.id, sellerText).then(sellerRes => {
        // even if seller notification fails, treat admin ok as success
        return { adminRes, sellerRes };
      });
    }
    return { adminRes, sellerRes: null };
  });
}

/* SUBMIT HANDLER */
submitBtn.addEventListener('click', async () => {
  // must have shared flag
if(!hasSharedFlag()){
    showPopup('You must share the bot link on WhatsApp before submitting. kindly click the "repost on whatsapp button" at the top of this page to share ‚òùÔ∏è‚òùÔ∏è‚òùÔ∏è‚òùÔ∏è', 'error', true);
    setStatus('You must share the bot link before submitting.', 'error');
    return;
  }

  safeShowAd();

  const missing = validateForm();
  if(missing.length){
    const list = missing.join(', ');
    showPopup(`Please complete required fields:<br><strong>${list}</strong>`, 'error', true);
    setStatus('Please complete required fields.', 'error');
    return;
  }

  // gather
  const name = productName.value.trim();
  const img = hostedImage.value.trim();
  const url = productUrl.value.trim();
  const price = productPrice.value.trim();
  const currency = currencyEl.value.trim();
  const desc = description.value.trim();
  const contact = contactInfo.value.trim();

  const productId = 'P' + Date.now();
  const dt = new Date().toLocaleString('en-GB', { timeZone: 'Africa/Lagos' });

  const adminMessage =
`üì¶ <b>New Product Submitted</b>
Product ID: ${productId}
Name: ${escapeHtml(name)}
Price: ${escapeHtml(price)} ${escapeHtml(currency)}
Image: ${escapeHtml(img)}
URL: ${escapeHtml(url)}
Description: ${escapeHtml(desc)}
Contact: ${escapeHtml(contact)}
Seller: ${escapeHtml(tgUser.first_name || '')}${tgUser.username ? '  @' + escapeHtml(tgUser.username) : ''}
Seller ID: ${tgUser.id || 'N/A'}
Date & Time: ${dt}

<b>‚¨áÔ∏è Product JSON (for marketplace use)</b>
<pre>{
  id: "${productId}",
  name: "${escapeHtml(name)}",
  description: "${escapeHtml(desc)}",
  price: "${escapeHtml(price)}",
  currency: "${escapeHtml(currency)}",
  image: "${escapeHtml(img)}",
  sellerId: ${tgUser.id || 'null'},
  sellerContact: "${escapeHtml(contact)}",
  url: "${escapeHtml(url)}"
}</pre>
`;

  const sellerMessage = 
`‚úÖ <b>Your product was submitted!</b>
Name: ${escapeHtml(name)}
Product ID: ${productId}
`;

  setStatus('Submitting product...', 'warning');

  try{
    const res = await sendTelegramMessages(adminMessage, sellerMessage);
    // check admin response ok
    if(res && res.adminRes && res.adminRes.ok){
      handleSubmitSuccess(productId);
    } else {
      throw new Error('Telegram returned an error.');
    }
  } catch(err){
    console.error('Submit error', err);
    handleSubmitFailure(err.message || 'Network or Telegram error.');
  }
});

/* Simple html-escape */
function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ----- MONETAG ADS SCHEDULING ----- */
/* We'll call the provided show_9830606() if available. Use a safe wrapper and debounce to avoid spamming. */
let adDebounce = false;
function safeShowAd(){
  // if already showing in the last 1s, skip
  if(adDebounce) return;
  adDebounce = true;
  setTimeout(()=> adDebounce = false, 1000);

  // attempt to call SDK function
  try{
    if(typeof window.show_9830606 === 'function') {
      window.show_9830606();
    } else {
      // fallback: try to call any global function named show_9830606 (some SDKs attach differently)
      const fn = window['show_9830606'] || window['show_9830606'];
      if(typeof fn === 'function') fn();
      // else nothing we can do ‚Äî SDK file may still load later; attempt again shortly
      else setTimeout(()=> { if(typeof window.show_9830606 === 'function') window.show_9830606(); }, 500);
    }
  } catch(e){
    console.warn('Ad show error', e);
  }
}

/* initial ad after 3 seconds, then every 35 seconds */
window.addEventListener('load', () => {
  setTimeout(()=> {
    safeShowAd();
    // schedule every 35s (35000ms)
    window._monetagInterval = setInterval(() => safeShowAd(), 60000);
  }, 3000);
});

/* ----- small utility nav buttons behavior ----- */
document.getElementById('reloadBtn').addEventListener('click', () => {
  // this is supposed to navigate the user to 'Sell Account' flow - for now we reload
  safeShowAd();
  // keep form open on reload by keeping formOpen flag
  sessionStorage.setItem('formOpen','1');
  location.reload();
});
document.getElementById('marketBtn').addEventListener('click', () => {
  safeShowAd();
  // navigate to marketplace (Telegram bot link)
  location.href="buy.html";
});

/* ----- utility: show a small non-blocking notice if they open the form without sharing (defensive) ----- */
if(sessionStorage.getItem('formOpen') === '1' && !hasSharedFlag()){
  showPopup('You opened the form previously. Please share the bot link on WhatsApp before submitting.', null, false, 6000);
}

/* ----- safety / fallback: if user closes or reloads, preserve some fields ‚Äî already handled by sessionStorage above ----- */

</script>
</body>
</html>