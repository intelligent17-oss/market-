<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Buy Product ‚Äî Intelligent Marketplace</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="product.js"></script>
<style>
  body { font-family: Arial,sans-serif; padding:20px; background:#f7f7f7; color:#111;
  margin-top:65px;
  }
  h2,h3 { margin-bottom:10px; }
  .product { background:#fff; padding:15px; margin:15px 0; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
  .product img { width:100%; max-width:300px; border-radius:6px; display:block; margin-bottom:10px; }
  .product-details p { margin:5px 0; }
  button { padding:10px; margin:5px 0; cursor:pointer; border:none; border-radius:6px; background:#000; color:#fff; }

  /* BUY MODAL */
  #buyModal { 
    display:none; 
    position:fixed; top:0; left:0; right:0; bottom:0; 
    background:rgba(0,0,0,0.6); 
    justify-content:center; 
    align-items:flex-start; 
    overflow-y:auto;
    padding:20px 10px;
  }
  #buyModal .modal-content { 
    background:#fff; 
    padding:20px; 
    border-radius:10px; 
    width:95%; 
    max-width:500px;
    word-break: break-word; 
  }
  #buyModal input, #buyModal select { width:100%; padding:10px; margin:10px 0; border-radius:6px; border:1px solid #ccc; }

  /* COPY BOXES */
  .copy-box {
    background:#eefaff;
    padding:12px;
    margin:10px 0;
    border-radius:8px;
    border:1px solid #8ed0ff;
    font-size:17px;
    font-weight:bold;
    display:flex;
    justify-content:space-between;
    align-items:center;
    word-break: break-word; 
  }
  .copy-btn {
    padding:6px 10px;
    background:#007bff;
    color:#fff;
    border:none;
    border-radius:6px;
    font-size:14px;
    cursor:pointer;
  }

  .nav { display:flex; gap:10px; margin:20px 0; }
  .nav button { flex:1; }
  a { color:blue; }

  #userInfo { margin-bottom:15px; display:flex; align-items:center; gap:10px; }
  #userInfo img { border-radius:50%; width:60px; height:60px; object-fit:cover; }

  /* MESSAGE BOX ‚Äî UPDATED FOR FIXED TOP AND MANUAL CLOSE */
  #msgBox {
    display: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
    font-size: 16px;
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    min-width: 300px;
    max-width: 90%;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    word-break: break-word;
    cursor: pointer;
  }

  /* ========== THEME (ADDITIONAL RULES ADDED) ========== */
  /* place toggle next to title */
  h2 { display:inline-block; vertical-align: middle; margin:0; }
  #themeToggle {
    display:inline-block;
    margin-left:12px;
    vertical-align: middle;
    padding:6px 10px;
    border-radius:6px;
    background:#000;
    color:#fff;
    border:none;
    cursor:pointer;
    font-size:16px;
  }
  /* MAKE BUY NOW BUTTON BIGGER */
.nnbb {
  width: 100%;
  padding: 18px !important;
  font-size: 20px !important;
  font-weight: bold !important;
  background: #1a73e8 !important;
  color: #fff !important;
  border-radius: 10px !important;
  margin-top: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.buyBtn {
  width: 100%;
  padding: 18px !important;
  font-size: 20px !important;
  font-weight: bold !important;
  background: #1a73e8 !important;
  color: #fff !important;
  border-radius: 10px !important;
  margin-top: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

  /* Dark theme styles */
  body.dark { background:#0f1113; color:#e6eef8; transition: background 0.25s, color 0.25s; }
  body.dark .product { background:#151719; box-shadow:0 4px 12px rgba(0,0,0,0.5); }
  body.dark .product-details p { color:#e6eef8; }
  body.dark button { background:#222; color:#fff; }
  body.dark .copy-box { background:#0f1720; border:1px solid #264653; color:#e6eef8; }
  body.dark .copy-btn { background:#2563eb; color:#fff; }
  body.dark #buyModal { background: rgba(0,0,0,0.7); }
  body.dark #buyModal .modal-content { background:#101214; color:#e6eef8; border:1px solid #222; }
  body.dark a { color:#66a6ff; }
  body.dark #themeToggle { background:#fff; color:#000; }

  /* ensure elements inside modal and a few inline styles adapt */
  body.dark input, body.dark select { background:#0b0d0f; color:#e6eef8; border:1px solid #2b2f33; }
  body.dark hr { border-top:1px solid #2a2a2a; }

  /* small spacing tweak so header doesn't overlap content */
  .header-wrap { margin-bottom:12px; display:block; }

  /* ===== PAYMENT RESULT POPUP ===== */
  #paymentPopup {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 99999;
    justify-content: center;
    align-items: center;
  }
  #paymentPopup .popup-content {
    background: #fff;
    padding: 25px;
    width: 90%;
    max-width: 420px;
    border-radius: 12px;
    text-align: center;
    font-size: 17px;
    font-weight: bold;
    box-shadow: 0 5px 18px rgba(0,0,0,0.3);
    animation: popIn 0.25s ease-out;
  }
  @keyframes popIn {
    from { transform: scale(0.7); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  .popup-success { border: 2px solid #28a745; color:#155724; background:#d4edda; }
  .popup-error { border: 2px solid #dc3545; color:#721c24; background:#f8d7da; }
  .pname {
    font-size: 20px;
  }
</style>
</head>

<body>

<div class="header-wrap">
  <h2>Intelligent Marketplace ‚Äî Buy Products</h2>
  <button id="themeToggle" aria-label="Toggle theme">üåô</button>
</div>

<!-- USER INFO -->
<div id="userInfo">
  <img id="profilePic" src="https://via.placeholder.com/60" alt="Profile">
  <div>
    <p id="fullName"></p>
    <p id="username"></p>
    <p id="userId"></p>
  </div>
</div>
<div style="background:#fff4ce; padding:10px; margin-top:5px; border-left:4px solid #ffbb00; border-radius:6px; font-size:14px; color:#8a6d00; font-weight:bold;">
‚ö†Ô∏è We show multiples of ads, in this webapp please stay patient for each ads, turning on ads blocker, might block some of our button from working expecialy selling of product.
</div>
  <p>Please make sure you  <a href="https://t.me/intelligentmarketbot?start=ar1810544353">start our bot </a> before you buy any product so that you will receive notification about the seller contact, release or refunds of any money and many more.... <a href="https://t.me/intelligentmarketbot?start=ar1810544353">start bot</a></p>
<!-- NAVIGATION -->
<div class="nav">
  <button id="sellBtn" class="nnbb">Sell Account</button>
  <button id="myProductBtn" class="hidden nnbb">My Product</button>
  <button id="buyAccountBtn" class="nnbb">Buy Account</button>
</div>

<!-- MESSAGE BOX -->
<div id="msgBox"></div>

<!-- PRODUCTS -->
<div id="productsContainer"></div>

<!-- BUY MODAL -->
<div id="buyModal">
  <div class="modal-content">
    <h3>Complete Your Payment</h3>
    <p id="paymentInfo"></p>

    <label><b>Account Number (NG ‚Äì Opay)</b> <p> Please use BTC, if the product you want to buy was in USD just click the "Show BTC option" button</p></label>
    <div class="copy-box">
      <span id="opayText">9114301708</span>
      <button class="copy-btn" onclick="copyText('opayText')">Copy</button>
    </div>

    <div class="copy-box">
      <span id="bankName">Opay Bank</span>
      <button class="copy-btn" onclick="copyText('bankName')">Copy</button>
    </div>

    <div class="copy-box">
      <span id="acctName">Ayomide Abdumalik Olatunji</span>
      <button class="copy-btn" onclick="copyText('acctName')">Copy</button>
    </div>

    <hr style="margin:15px 0; border:0; border-top:1px solid #ccc;">
<p> Please use BTC, if the product you want to buy was in USD just click the "Show BTC option" button</p>
    <button onclick="toggleBTC()" style="width:100%; background:#222; padding:10px; border-radius:6px; color:#fff; margin:10px 0;">
      Show BTC Payment Option
    </button>

    <div id="btcSection" style="display:none;">
      <label><b>BTC Address (For Foreign Buyers)</b></label>
      <div class="copy-box">
        <span id="btcText">bc1qxhyddpkgvdc68tj9xk5gf5k2vnxmnfy4xrwwr4</span>
        <button class="copy-btn" onclick="copyText('btcText')">Copy</button>
      </div>
      <div class="copy-box">
        <span id="btcNetwork">Bitcoin ‚Äî BTC Network</span>
        <button class="copy-btn" onclick="copyText('btcNetwork')">Copy</button>
      </div>
      <div style="background:#fff4ce; padding:10px; margin-top:5px; border-left:4px solid #ffbb00; border-radius:6px; font-size:14px; color:#8a6d00; font-weight:bold;">
        ‚ö†Ô∏è Trust Wallet is Recommended for BTC Payments
      </div>
    </div>

    <div style="background:#ffe6e6; padding:12px; border-radius:8px; margin-top:15px; font-weight:bold; color:#d8000c; text-align:center; font-size:16px;">
      Payment Time Left: <span id="timer">05:00</span>
    </div>

    <label>Upload Payment Screenshot:</label>
    <input type="file" id="paymentScreenshot" accept="image/*">

    <label><b>Select Contact Method</b></label>
    <select id="contactMethod">
      <option value="">Select contact method</option>
      <option value="WhatsApp">WhatsApp</option>
      <option value="Telegram">Telegram</option>
      <option value="WeChat">WeChat</option>
      <option value="Google Chat">Google Chat</option>
    </select>

    <label><b>Enter your Contact Username/Number</b></label>
    <input type="text" id="buyerContact" placeholder="Enter your contact here">

    <button id="submitPayment" class="nnbb">Submit Payment</button>
    <button id="closeModal" style="background:#dc3545;">Cancel</button>
  </div>
</div>

<!-- PAYMENT RESULT POPUP -->
<div id="paymentPopup">
  <div class="popup-content" id="paymentPopupContent"></div>
</div>

<!-- Monetag SDK -->
<script src="//libtl.com/sdk.js" data-zone="9830606" data-sdk="show_9830606"></script>

<script>
// TELEGRAM WEBAPP
Telegram.WebApp.ready();
Telegram.WebApp.expand();

// THEME: auto-detect + manual override
(function(){
  const toggleBtn = document.getElementById('themeToggle');
  const userPref = localStorage.getItem('site-theme'); // "dark" or "light" or null
  function applyTheme(theme){
    if(theme === 'dark'){
      document.body.classList.add('dark');
      toggleBtn.textContent = '‚òÄÔ∏è';
      toggleBtn.setAttribute('aria-pressed','true');
    } else {
      document.body.classList.remove('dark');
      toggleBtn.textContent = 'üåô';
      toggleBtn.setAttribute('aria-pressed','false');
    }
  }
  if(userPref === 'dark' || userPref === 'light'){
    applyTheme(userPref);
  } else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
    applyTheme('dark');
  } else { applyTheme('light'); }

  if(!userPref && window.matchMedia){
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener
      ? window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => applyTheme(e.matches ? 'dark' : 'light'))
      : window.matchMedia('(prefers-color-scheme: dark)').addListener(e => applyTheme(e.matches ? 'dark' : 'light'));
  }

  toggleBtn.addEventListener('click', () => {
    const nowDark = document.body.classList.toggle('dark');
    applyTheme(nowDark ? 'dark' : 'light');
    try { localStorage.setItem('site-theme', nowDark ? 'dark' : 'light'); } catch(e){}
  });
})();

// USER INFO
const tgUser = Telegram.WebApp.initDataUnsafe.user || {};
document.getElementById('fullName').textContent = tgUser.first_name + (tgUser.last_name ? " " + tgUser.last_name : "");
document.getElementById('username').textContent = tgUser.username ? "@" + tgUser.username : "";
document.getElementById('userId').textContent = "Telegram ID: " + (tgUser.id || "");
if(tgUser.photo_url) document.getElementById('profilePic').src = tgUser.photo_url;

// MESSAGE FUNCTION
function showMessage(message, type="success") {
  const box = document.getElementById('msgBox');
  box.style.color = type==="success" ? "#155724" : type==="pending" ? "#856404" : "#721c24";
  box.style.background = type==="success" ? "#d4edda" : type==="pending" ? "#fff3cd" : "#f8d7da";
  box.style.border = type==="success" ? "1px solid #c3e6cb" : type==="pending" ? "1px solid #ffeeba" : "1px solid #f5c6cb";
  box.textContent = message;
  box.style.display = "block";
  box.onclick = () => { box.style.display = "none"; };
}

// COPY FUNCTION
function copyText(id){
  const text = document.getElementById(id).innerText;
  navigator.clipboard.writeText(text).then(()=> showMessage("Copied: " + text));
}

// BTC COLLAPSE
function toggleBTC() {
  const btc = document.getElementById("btcSection");
  btc.style.display = btc.style.display === "none" ? "block" : "none";
}

// TIMER FUNCTION
let timeLeft = 300; // 5 minutes
function startTimer() {
  const timerElement = document.getElementById("timer");
  const countdown = setInterval(() => {
    let min = Math.floor(timeLeft / 60);
    let sec = timeLeft % 60;
    timerElement.textContent = (min<10?"0":"")+min+":"+(sec<10?"0":"")+sec;
    if(timeLeft<=0){ clearInterval(countdown); showMessage("Payment time expired. Please try again.","error"); buyModal.style.display="none"; }
    timeLeft--;
  },1000);
}

// SHOW MODAL WITH TIMER
function openBuyModal() { timeLeft=300; startTimer(); buyModal.style.display="flex"; }
const buyModal = document.getElementById('buyModal');
document.getElementById('closeModal').onclick = ()=> buyModal.style.display="none";
const container = document.getElementById('productsContainer');
let currentProduct = null;

function renderProducts(){
  container.innerHTML = "";
  productsData.forEach((prod)=>{
    const div = document.createElement('div');
    div.className="product";
    div.innerHTML=`
      <div class="product-details">
        <p class="pname"><b>${prod.name}</b></p>
        <br>
     <img src="${prod.image}">
        <p>URL: <a href="${prod.url}" target="_blank">${prod.url}</a></p>
        <p>Price: ${prod.price} ${prod.currency}</p>
        <p>${prod.description}</p>
        <button class="buyBtn"> Buy Now </button>
      </div>
    `;
    container.appendChild(div);
  });

  document.querySelectorAll('.buyBtn').forEach((btn,i)=>{
    btn.onclick = ()=>{
      currentProduct = productsData[i];
      showPaymentInfo();
      openBuyModal();
    };
  });
}

function showPaymentInfo(){
  const fee = currentProduct.currency === "NGN" ? 1000 : 1;
  const total = Number(currentProduct.price) + fee;
  document.getElementById('paymentInfo').innerHTML = `
    <b>Product:</b> ${currentProduct.name}<br>
    <b>Price:</b> ${currentProduct.price} ${currentProduct.currency}<br>
    <b>Fee:</b> ${fee} ${currentProduct.currency}<br><br>
    <b>Total:</b> ${total} ${currentProduct.currency}
  `;
}

renderProducts();

// TELEGRAM BOT
const BOT_TOKEN = "7514817340:AAHUpE5ZPEUZkkM4rq4smoV_nzWfmwWBVGc";
const ADMIN_ID = "8140042906"; // Admin Telegram ID

function sendTelegramMessage(chatId, message){
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: chatId, text: message, parse_mode:"HTML" })
    });
}

function sendTelegramPhoto(chatId, photoFile, caption){
    const formData = new FormData();
    formData.append("chat_id", chatId);
    formData.append("photo", photoFile);
    formData.append("caption", caption);
    formData.append("parse_mode", "HTML");
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method: "POST", body: formData });
}

// PAYMENT SUBMISSION
document.getElementById('submitPayment').onclick = () => {
  const fileInput = document.getElementById('paymentScreenshot');
  const file = fileInput.files[0];
  const method = document.getElementById('contactMethod').value;
  const contact = document.getElementById('buyerContact').value;
  
  if(!file) return showPaymentPopup("Upload payment screenshot!","error");
  if(!method) return showPaymentPopup("Select contact method!","error");
  if(!contact) return showPaymentPopup("Enter your contact!","error");
  
  buyModal.style.display = "none";

  const buyerName = tgUser.first_name + (tgUser.last_name ? " " + tgUser.last_name : "");
  const buyerUsername = tgUser.username ? "@" + tgUser.username : "";
  const buyerId = tgUser.id || "";

  const sellerId = currentProduct.sellerId;
  const sellerContact = currentProduct.sellerContact || "Not provided";
  const productName = currentProduct.name;
  const productPrice = currentProduct.price + " " + currentProduct.currency;
  const productId = currentProduct.id;
  const productURL = currentProduct.url;

  // Show popup success message
  showPaymentPopup(`
    Payment Submitted Successfully!<br><br>
    <b>Product:</b> ${productName}<br>
    <b>Price:</b> ${productPrice}<br>
    Admin will review it soon.
  `, "success");

  // Notify admin with screenshot
  const adminCaption = `
<b>New Payment Screenshot Request</b>
Product: ${productName}
Product ID: ${productId}
Price: ${productPrice}
Buyer: ${buyerName} (${buyerUsername})
Buyer ID: ${buyerId}
Buyer Contact: ${contact} (${method})
Seller ID: ${sellerId}
Seller Contact: ${sellerContact}
Product URL: ${productURL}
`;

  sendTelegramPhoto(ADMIN_ID, file, adminCaption);

  const buyerMessage = `
A request to buy <b>${productName}</b> for <b>${productPrice}</b> has been submitted.
Admin will review it within a few hours.
You can request a refund or release the payment once admin verifies and notifies the seller.
`;
  sendTelegramMessage(buyerId, buyerMessage);

  const sellerMessage = `
Someone requested to buy your product: <b>${productName}</b>
Product ID: ${productId}
Price: ${productPrice}
Admin is reviewing the buyer's payment.
Once verified, you will be credited after the buyer releases the money.
`;
  sendTelegramMessage(sellerId, sellerMessage);
};

// PAYMENT POPUP FUNCTION
function showPaymentPopup(message, type="success"){
  const popup = document.getElementById("paymentPopup");
  const content = document.getElementById("paymentPopupContent");
  content.innerHTML = message;
  content.className = "popup-content " + (type==="success" ? "popup-success" : "popup-error");
  popup.style.display = "flex";
  popup.onclick = () => { popup.style.display = "none"; };
}

// NAVIGATION
document.getElementById('sellBtn').onclick = ()=> { location.href="index.html"; };
document.getElementById('buyAccountBtn').onclick = ()=> location.reload();

// Monetag Ads
function showAd() { if(typeof show_9830606==="function"){ show_9830606(); } else { setTimeout(showAd,500); } }
window.addEventListener("load", () => {
    setTimeout(() => { showAd(); setInterval(showAd, 40000); }, 3000);
});

// MY PRODUCT FEATURE
const myProductBtn = document.getElementById('myProductBtn');
const userProducts = productsData.filter(p => p.sellerId === tgUser.id);
if(userProducts.length > 0) myProductBtn.classList.remove('hidden');

myProductBtn.onclick = () => {
  container.innerHTML = "";
  if(userProducts.length === 0){
    showMessage("You don't have any product yet. Click OK to sell one.","error");
    location.href = "index.html";
    return;
  }
  userProducts.forEach((prod) => {
    const div = document.createElement('div');
    div.className = "product";
    div.innerHTML = `
      <img src="${prod.image}">
      <div class="product-details">
        <p><b>${prod.name}</b></p>
        <p>URL: <a href="${prod.url}" target="_blank">${prod.url}</a></p>
        <p>Price: ${prod.price} ${prod.currency}</p>
        <p>${prod.description}</p>
        <button class="deleteBtn">Request Delete</button>
      </div>
    `;
    container.appendChild(div);

    div.querySelector('.deleteBtn').onclick = () => {
      if(confirm(`Are you sure you want to request deletion of "${prod.name}"?`)){
        const sellerId = prod.sellerId;
        const productName = prod.name;
        const productId = prod.id;
        const productPrice = prod.price + " " + prod.currency;
        const productURL = prod.url;
        const sellerContact = prod.sellerContact || "Not provided";

        const adminMessage = `
<b>Delete Request</b>
Product: ${productName}
Product ID: ${productId}
Price: ${productPrice}
Seller ID: ${sellerId}
Seller Contact: ${sellerContact}
Product URL: ${productURL}
`;
        sendTelegramMessage(ADMIN_ID, adminMessage);

        const sellerMessage = `
Your product <b>${productName}</b> has a deletion request sent to admin.
Admin will review and take action.
`;
        sendTelegramMessage(sellerId, sellerMessage);

        showMessage(`Delete request for "${prod.name}" has been sent to admin.`,"success");
      }
    };
  });
};
</script>
</body>
</html>