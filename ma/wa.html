<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Wallet ‚Äî Intelligent Marketplace</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="balance.js"></script>

<style>
/* === DESIGN UNCHANGED === */
body{font-family:Arial,sans-serif;background:#f4f6f8;color:#111;padding:20px;margin:0}
.header-wrap{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
h2{margin:0;font-size:20px}
#themeToggle{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-size:16px;background:#000;color:#fff;width:50px}
.card{background:#fff;padding:18px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.12);margin-bottom:14px;overflow:hidden}
#userInfo{display:flex;align-items:center;gap:12px}
#profilePic{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#eee}
#name{font-size:18px;font-weight:bold;margin:0}
#username,#userid{margin:4px 0 0 0;color:#444;font-size:14px}
.bal-big{font-size:34px;font-weight:900;margin:2px 0 0 0}
.bal-sub{margin:6px 0 0 0;color:#555;font-weight:bold}
.bal-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.pill{padding:8px 10px;border-radius:10px;background:#eefaff;border:1px solid #8ed0ff;font-weight:bold;font-size:14px}
button{width:100%;padding:16px;font-size:18px;font-weight:bold;border:none;border-radius:10px;cursor:pointer;margin-top:10px}
.sell{background:#1a73e8;color:#fff}
.withdraw{background:#28a745;color:#fff}
.ghost{background:#444;color:#fff}
input,select{width:100%;padding:12px;margin-top:10px;border-radius:8px;border:1px solid #ccc}
.hidden{display:none}
.pending-item{background:#fff4ce;border-left:4px solid #ffbb00;padding:10px;border-radius:8px;margin-top:10px;font-size:14px;font-weight:bold;color:#6b5200}
.pending-item.success{background:#d4edda;border-left-color:#28a745;color:#155724}
.muted{font-size:12px;font-weight:bold;opacity:.85;margin-top:6px}
</style>
</head>

<body>

<div class="header-wrap">
  <h2>Intelligent Marketplace ‚Äî Wallet</h2>
</div>

<div class="card" id="userInfo">
  <img id="profilePic" src="https://via.placeholder.com/64">
  <div>
    <p id="name"></p>
    <p id="username"></p>
    <p id="userid"></p>
  </div>
</div>

<div class="card">
  <div><b>Available Balance</b></div>
  <div class="bal-big" id="ngnBal">‚Ç¶0</div>
  <div class="bal-sub" id="usdBal">‚âà $0.00</div>

  <div class="bal-row">
    <div class="pill" id="pillBase">Base: ‚Ç¶0</div>
    <div class="pill" id="pillPending">Pending: ‚Ç¶0</div>
  </div>
</div>

<div class="card">
  <button class="withdraw" onclick="openWithdraw()">Withdraw</button>
  <button class="sell" onclick="location.href='index.html'">Sell Products</button>
</div>

<div class="card hidden" id="withdrawBox">
  <select id="method" onchange="switchMethod()">
    <option value="">Select method</option>
    <option value="bank">Bank Transfer</option>
    <option value="bnb">BNB (BEP20)</option>
  </select>

  <div id="bankBox" class="hidden">
    <input id="bankAmount" placeholder="Amount NGN">
    <input id="bankNumber" placeholder="Account Number">
    <input id="bankName" placeholder="Bank Name">
    <input id="bankHolder" placeholder="Account Name">
    <button class="withdraw" onclick="submitBank()">Submit</button>
  </div>

  <div id="bnbBox" class="hidden">
    <input id="bnbAddress" placeholder="BNB Address">
    <input id="bnbAmount" placeholder="Amount USD">
    <button class="withdraw" onclick="submitBNB()">Submit</button>
  </div>

  <button class="ghost" onclick="closeWithdraw()">Close</button>
</div>

<div class="card">
  <b>‚è≥ Withdrawal History</b>
  <div id="pendingList" class="muted">No withdrawal history yet.</div>
</div>

<script>
/* ===== TELEGRAM ===== */
Telegram.WebApp.ready();
Telegram.WebApp.expand();
const tgUser = Telegram.WebApp.initDataUnsafe.user || {};

/* ===== BOT CONFIG ===== */
const BOT_TOKEN = "7514817340:AAHUpE5ZPEUZkkM4rq4smoV_nzWfmwWBVGc";
const ADMIN_ID = "8140042906";

function sendTelegram(chatId, text){
  fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:chatId,text:text})
  });
}

/* ===== USER ===== */
name.textContent = (tgUser.first_name||"") + (tgUser.last_name?" "+tgUser.last_name:"");
username.textContent = tgUser.username ? "@"+tgUser.username : "No username";
userid.textContent = "Telegram ID: "+(tgUser.id||"");
if(tgUser.photo_url) profilePic.src = tgUser.photo_url;

/* ===== RATE ===== */
let rate = 1500;
fetch("https://open.er-api.com/v6/latest/USD")
  .then(r=>r.json())
  .then(d=>rate=d.rates.NGN||1500);

/* ===== ADMIN BALANCE (SOURCE OF TRUTH) ===== */
const baseBalance = walletBalances[tgUser.id] || 0;

/* ===== STORAGE ===== */
const STORE_KEY = "withdrawals_"+tgUser.id;
const LAST_BAL_KEY = "last_balance_"+tgUser.id;

let withdrawals = JSON.parse(localStorage.getItem(STORE_KEY)) || [];
const lastBalance = Number(localStorage.getItem(LAST_BAL_KEY));

/* ===== SYNC: IF balance.js CHANGED ‚Üí ALL SUCCESS ===== */
if (!isNaN(lastBalance) && lastBalance !== baseBalance) {
  withdrawals = withdrawals.map(w =>
    w.status === "PENDING"
      ? {...w, status:"SUCCESS", approvedAt:new Date().toISOString()}
      : w
  );
  localStorage.setItem(STORE_KEY, JSON.stringify(withdrawals));
}
localStorage.setItem(LAST_BAL_KEY, baseBalance);

/* ===== CALC ===== */
function pendingTotal(){
  return withdrawals.filter(w=>w.status==="PENDING")
    .reduce((s,w)=>s+w.amountNGN,0);
}
function availableBalance(){
  return baseBalance - pendingTotal();
}

/* ===== UI ===== */
function updateUI(){
  const avail = Math.max(0, availableBalance());
  ngnBal.textContent = "‚Ç¶"+avail.toLocaleString();
  usdBal.textContent = "‚âà $"+(avail/rate).toFixed(2);
  pillBase.textContent = "Base: ‚Ç¶"+baseBalance.toLocaleString();
  pillPending.textContent = "Pending: ‚Ç¶"+pendingTotal().toLocaleString();

  pendingList.innerHTML = withdrawals.length
    ? withdrawals.slice().reverse().map(w=>`
      <div class="pending-item ${w.status==="SUCCESS"?"success":""}">
        ${w.method} ‚Äî ‚Ç¶${w.amountNGN}<br>Status: ${w.status}
      </div>`).join("")
    : "No withdrawal history yet.";
}
updateUI();

/* ===== WITHDRAW UI ===== */
function openWithdraw(){withdrawBox.classList.remove("hidden")}
function closeWithdraw(){withdrawBox.classList.add("hidden")}
function switchMethod(){
  bankBox.classList.toggle("hidden",method.value!=="bank");
  bnbBox.classList.toggle("hidden",method.value!=="bnb");
}

/* ===== BANK ===== */
function submitBank(){
  const amt = Number(bankAmount.value);
  if(amt < 5000) return alert("Minimum withdrawal ‚Ç¶5,000");
  if(amt > availableBalance()) return alert("Insufficient balance");

  withdrawals.push({method:"BANK",amountNGN:amt,status:"PENDING"});
  localStorage.setItem(STORE_KEY,JSON.stringify(withdrawals));
  updateUI();

  sendTelegram(ADMIN_ID,`üí∏ Withdrawal Request\nUser: ${name.textContent}\nID: ${tgUser.id}\nAmount: ‚Ç¶${amt}\nBalance: ‚Ç¶${baseBalance}`);
  sendTelegram(tgUser.id,`Your withdrawal of ‚Ç¶${amt} is pending. Processing may take 24 hours.`);
}

/* ===== BNB ===== */
function submitBNB(){
  const usd = Number(bnbAmount.value);
  const ngn = Math.round(usd*rate);
  if(usd < 20) return alert("Minimum withdrawal $20");
  if(ngn > availableBalance()) return alert("Insufficient balance");

  withdrawals.push({method:"BNB",amountNGN:ngn,status:"PENDING"});
  localStorage.setItem(STORE_KEY,JSON.stringify(withdrawals));
  updateUI();

  sendTelegram(ADMIN_ID,`üí∏ Withdrawal Request\nUser: ${name.textContent}\nID: ${tgUser.id}\nAmount: $${usd}\nBalance: ‚Ç¶${baseBalance}`);
  sendTelegram(tgUser.id,`Your withdrawal of $${usd} is pending. Processing may take 24 hours.`);
}
</script>

</body>
</html>