<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Wallet ‚Äî Intelligent Marketplace</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://marketbalance.onrender.com/balance.js"></script>

<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:20px;color:#111}
h2{margin-bottom:10px}
.card{background:#fff;padding:18px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.12);margin-bottom:14px}
#userInfo{display:flex;gap:12px;align-items:center}
#profilePic{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#eee}
.bal-big{font-size:34px;font-weight:900}
.bal-sub{font-weight:bold;color:#555}
.row{display:flex;gap:10px;margin-top:10px}
.pill{padding:8px 10px;border-radius:10px;background:#eefaff;border:1px solid #8ed0ff;font-weight:bold}
button{width:100%;padding:16px;font-size:17px;font-weight:bold;border:none;border-radius:10px;margin-top:10px;cursor:pointer}
.withdraw{background:#28a745;color:#fff}
.withdraw.locked{background:#aaa;cursor:not-allowed}
.sell{background:#1a73e8;color:#fff}
input,select{width:100%;padding:12px;margin-top:10px;border-radius:8px;border:1px solid #ccc}
.hidden{display:none}

/* center message */
.msg{
  position:fixed;top:50%;left:50%;
  transform:translate(-50%,-50%);
  padding:18px 22px;
  border-radius:12px;
  font-weight:bold;
  z-index:9999;
  box-shadow:0 10px 30px rgba(0,0,0,.3);
}
.msg.success{background:#d4edda;color:#155724}
.msg.error{background:#f8d7da;color:#721c24}
</style>
</head>

<body>

<h2>Intelligent Marketplace ‚Äî Wallet</h2>

<div class="card" id="userInfo">
  <img id="profilePic">
  <div>
    <div id="name"></div>
    <div id="username"></div>
    <div id="userid"></div>
  </div>
</div>

<div class="card">
  <b>Available Balance</b>
  <div class="bal-big" id="ngnBal">‚Ç¶0.00</div>
  <div class="bal-sub" id="usdBal">‚âà $0.00</div>
  <div class="row">
    <div class="pill" id="baseBal">Base: ‚Ç¶0</div>
  </div>
</div>
<div class="card">
  <h3>Withdrawal History</h3>
  <div id="historyBox">
    <i>No withdrawal history yet</i>
  </div>
</div>
<div class="card">
  <button id="withdrawBtn" class="withdraw" onclick="openWithdraw()">Withdraw</button>
  <button class="sell" onclick="location.href='index.html'">Sell Products</button>
</div>

<!-- Withdraw box -->
<div class="card hidden" id="withdrawBox">
  <select id="method" onchange="switchMethod()">
    <option value="">Select withdrawal method</option>
    <option value="bank">Bank Transfer</option>
    <option value="bnb">BNB (BEP20)</option>
  </select>

  <div id="bankBox" class="hidden">
<input id="bankAmount" placeholder="Amount (NGN)" type="number">

<input id="accountNumber" placeholder="Account Number" type="number">

<select id="bankSelect" onchange="checkOtherBank()">
  <option value="">Select Bank</option>
  <option value="Access Bank">Access Bank</option>
  <option value="Kuda">Kuda</option>
  <option value="First Bank">First Bank</option>
  <option value="Opay (paycom)">Opay</option>
  <option value="UBA">UBA</option>
  <option value="Monie point">Monie point</option>
  <option value="Union Bank">Union Bank</option>
  <option value="FCMB">FCMB</option>
  <option value="Palmpay">Palmpay</option>
  <option value="Wema Bank">Wema Bank</option>
  <option value="Other">Other Bank</option>
</select>

<input id="otherBank" class="hidden" placeholder="Enter Bank Name">

<input id="accountName" placeholder="Account Name">

<button class="withdraw" onclick="submitBank()">Submit</button>
  </div>

  <div id="bnbBox" class="hidden">
    <input placeholder="BNB (BEP20) Address">
    <input id="bnbAmount" placeholder="Amount (USD)">
    <button class="withdraw" onclick="submitBNB()">Submit</button>
  </div>

  <button class="sell" onclick="closeWithdraw()">Close</button>
</div>

<div id="msgBox" class="msg hidden"></div>
<script>
/* =========================
   TELEGRAM INIT
========================= */
Telegram.WebApp.ready();
Telegram.WebApp.expand();

const user = Telegram.WebApp.initDataUnsafe.user || {};
const BOT_TOKEN = "7514817340:AAHUpE5ZPEUZkkM4rq4smoV_nzWfmwWBVGc";   // ‚ö†Ô∏è put in backend later (don‚Äôt keep token in frontend)
const ADMIN_ID  = "6940101627";

/* =========================
   STORAGE
========================= */
const WALLET_KEY = "IM_WALLET_FOREVER";

function saveWallet(data){
  localStorage.setItem(WALLET_KEY, JSON.stringify(data));
}
function loadWallet(){
  try { return JSON.parse(localStorage.getItem(WALLET_KEY)); }
  catch(e){ return null; }
}

/* =========================
   EXCHANGE RATE
========================= */
let rate = 1500;
fetch("https://open.er-api.com/v6/latest/USD")
  .then(r => r.json())
  .then(d => rate = d?.rates?.NGN || 1500)
  .catch(()=> rate = 1500);

/* =========================
   USER UI
========================= */
name.textContent = (user.first_name||"") + (user.last_name ? " "+user.last_name : "");
username.textContent = user.username ? "@"+user.username : "No username";
userid.textContent = "Telegram ID: "+(user.id||"");
profilePic.src = user.photo_url || "https://via.placeholder.com/64";

/* =========================
   STATE
========================= */
let wallet = loadWallet();
let balanceNGN = 0;
let hasWallet = false;

/* =========================
   UI FUNCTIONS
========================= */
function updateUI(){
  ngnBal.textContent = "‚Ç¶" + (balanceNGN||0).toLocaleString();
  usdBal.textContent = "‚âà $" + ((balanceNGN||0) / rate).toFixed(2);
  baseBal.textContent = "Base: ‚Ç¶" + (balanceNGN||0).toLocaleString();
}

function renderHistory(){
  const w = loadWallet();
  const history = (w && Array.isArray(w.history)) ? w.history : [];

  if(history.length === 0){
    historyBox.innerHTML = "<i>No withdrawal history yet</i>";
    return;
  }

  historyBox.innerHTML = history.slice().reverse().map((h,i)=>`
    <div style="
      padding:14px;margin-bottom:12px;border-radius:10px;background:#fff;
      border-left:6px solid ${
        h.status === "success" ? "#28a745" :
        h.status === "pending" ? "#ffc107" : "#dc3545"
      };
      box-shadow:0 4px 10px rgba(0,0,0,.08);
    ">
      <div style="font-weight:bold;margin-bottom:4px;">
        #${history.length - i} ‚Ä¢ ${h.type} Withdrawal
      </div>
      <div>üí∞ Amount: <b>‚Ç¶${h.amount ?? h.ngn ?? ""}</b></div>
      <div>üìå Status: <b>${String(h.status||"").toUpperCase()}</b></div>
      <div>üïí Requested: ${h.requestedAt ? new Date(h.requestedAt).toLocaleString() : ""}</div>
      ${h.bank ? `<div>üè¶ Bank: ${h.bank}</div>` : ""}
      ${h.approvedAt ? `<div>‚úÖ Approved: ${new Date(h.approvedAt).toLocaleString()}</div>` : ""}
    </div>
  `).join("");
}

function showMsg(text,type){
  msgBox.textContent = text;
  msgBox.className = "msg " + type;
  msgBox.classList.remove("hidden");
  setTimeout(()=>msgBox.classList.add("hidden"),3000);
}

/* =========================
   BALANCE.JS LOADING CHECK
========================= */
function getAdminBalance(){
  // balance.js must define window.walletBalances = {...}
  if(!window.walletBalances) return null;

  const val = window.walletBalances[user.id];
  return (typeof val === "number") ? val : null;
}

/* =========================
   INITIAL WALLET SETUP
========================= */
function initWalletIfPossible(){
  const adminBal = getAdminBalance();
  wallet = loadWallet();

  // First time user: only create wallet if admin has added them in balance.js
  if(!wallet && adminBal !== null){
    wallet = {
      userId: user.id,
      adminBalance: adminBal,
      balanceNGN: adminBal,
      history: []
    };
    saveWallet(wallet);
  }

  // Existing wallet
  if(wallet && wallet.userId === user.id){
    hasWallet = true;
    balanceNGN = wallet.balanceNGN;
  } else {
    hasWallet = false;
    balanceNGN = 0;
  }

  if(!hasWallet){
    withdrawBtn.classList.add("locked");
  } else {
    withdrawBtn.classList.remove("locked");
  }

  updateUI();
  renderHistory();
}

/* =========================
   AUTO APPROVAL LOGIC (THE MAIN FIX)
========================= */
function syncAndAutoApprove(){
  wallet = loadWallet();
  if(!wallet || wallet.userId !== user.id) return;

  const adminBal = getAdminBalance();
  if(adminBal === null) return; // user not in balance.js yet OR balance.js not loaded

  // If adminBalance changed => mark all pending as success
  if(adminBal !== wallet.adminBalance){
    (wallet.history || []).forEach(h=>{
      if(h.status === "pending"){
        h.status = "success";
        h.approvedAt = new Date().toISOString();
      }
    });

    wallet.adminBalance = adminBal;
    wallet.balanceNGN = adminBal;
    balanceNGN = adminBal;

    saveWallet(wallet);
    updateUI();
    renderHistory();
  }
}

/* =========================
   KEEP CHECKING (SO IT WORKS WITHOUT REFRESH)
========================= */
initWalletIfPossible();

// check every 3 seconds: balance.js loaded? admin updated? approve?
setInterval(() => {
  initWalletIfPossible();
  syncAndAutoApprove();
}, 3000);

/* =========================
   WITHDRAW UI
========================= */
function openWithdraw(){
  if(!hasWallet) return showMsg("‚ùå You cant withdraw yet Minimum balace to withdraw is NGN5000","error");
  if(balanceNGN < 5000) return showMsg("‚ùå Minimum withdrawal is ‚Ç¶5,000","error");
  withdrawBox.classList.remove("hidden");
}
function closeWithdraw(){ withdrawBox.classList.add("hidden"); }
function switchMethod(){
  bankBox.classList.toggle("hidden", method.value !== "bank");
  bnbBox.classList.toggle("hidden", method.value !== "bnb");
}

/* =========================
   TELEGRAM SEND
========================= */
function sendTG(chatId,text){
  fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ chat_id:chatId, text })
  });
}

/* =========================
   BANK WITHDRAW
========================= */
function submitBank(){
  if(!wallet || wallet.userId !== user.id) return showMsg("‚ùå Wallet not ready","error");

  const amt = Number(bankAmount.value);
  if(!amt || amt < 5000) return showMsg("‚ùå Minimum withdrawal is ‚Ç¶5,000","error");
  if(amt > balanceNGN) return showMsg("‚ùå Insufficient balance","error");

  const bankName = bankSelect.value === "Other" ? otherBank.value : bankSelect.value;
  if(!bankName) return showMsg("‚ùå Please select a bank","error");
  if(bankSelect.value === "Other" && !otherBank.value) return showMsg("‚ùå Enter bank name","error");
  if(!accountNumber.value || !accountName.value) return showMsg("‚ùå Fill all bank details","error");

  balanceNGN -= amt;

  wallet.history = wallet.history || [];
  wallet.history.push({
    type:"BANK",
    amount:amt,
    bank:bankName,
    account: accountNumber.value,
    name: accountName.value,
    status:"pending",
    requestedAt:new Date().toISOString()
  });
  wallet.balanceNGN = balanceNGN;

  saveWallet(wallet);
  updateUI();
  renderHistory();

  sendTG(ADMIN_ID, `Withdrawal Request\nID: ${user.id}\nMethod: BANK\nAmount: ‚Ç¶${amt}\nBank: ${bankName}\nAcct: ${accountNumber.value}\nName: ${accountName.value}`);
  sendTG(user.id, `Your bank withdrawal request is pending.\nAmount: ‚Ç¶${amt}\nProcessing time: up to 24 hours`);

  showMsg("‚úÖ Withdrawal submitted","success");
  closeWithdraw();
}

/* =========================
   BNB WITHDRAW
========================= */
function submitBNB(){
  if(!wallet || wallet.userId !== user.id) return showMsg("‚ùå Wallet not ready","error");

  const usd = Number(bnbAmount.value);
  if(!usd || usd < 20) return showMsg("‚ùå Minimum withdrawal is $20","error");

  const ngn = Math.round(usd * rate);
  if(ngn > balanceNGN) return showMsg("‚ùå Insufficient balance","error");

  balanceNGN -= ngn;

  wallet.history = wallet.history || [];
  wallet.history.push({
    type:"BNB",
    usd, ngn,
    status:"pending",
    requestedAt:new Date().toISOString()
  });
  wallet.balanceNGN = balanceNGN;

  saveWallet(wallet);
  updateUI();
  renderHistory();

  sendTG(ADMIN_ID, `Withdrawal Request\nID: ${user.id}\nMethod: BNB\nAmount: $${usd} (~‚Ç¶${ngn})`);
  sendTG(user.id, `Your BNB withdrawal request is pending.\nAmount: $${usd}\nProcessing time: up to 24 hours`);

  showMsg("‚úÖ Withdrawal submitted","success");
  closeWithdraw();
}
</script>
<script>
  function checkOtherBank(){
  otherBank.classList.toggle(
    "hidden",
    bankSelect.value !== "Other"
  );
}
</script>
</body>
</html>