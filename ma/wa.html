<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Wallet ‚Äî Intelligent Marketplace</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="balance.js"></script>

<style>
body{font-family:Arial;background:#f7f7f7;padding:20px}
.card{background:#fff;padding:18px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.12);margin-bottom:15px}
button{width:100%;padding:16px;font-size:18px;font-weight:bold;border:none;border-radius:10px;margin-top:10px;cursor:pointer}
.sell{background:#1a73e8;color:#fff}
.withdraw{background:#28a745;color:#fff}
input,select{width:100%;padding:12px;margin-top:10px;border-radius:8px;border:1px solid #ccc}
.hidden{display:none}

#msgBox{
 display:none;position:fixed;top:10px;left:50%;
 transform:translateX(-50%);
 padding:12px;border-radius:8px;
 font-weight:bold;z-index:9999;
}

#popup{
 display:none;position:fixed;top:0;left:0;right:0;bottom:0;
 background:rgba(0,0,0,.6);
 justify-content:center;align-items:center;z-index:99999;
}
.popup-content{
 background:#fff;padding:25px;border-radius:12px;
 width:90%;max-width:420px;font-weight:bold;text-align:center;
}
.popup-success{background:#d4edda;color:#155724;border:2px solid #28a745}
.popup-error{background:#f8d7da;color:#721c24;border:2px solid #dc3545}

.pending{
 background:#fff4ce;
 border-left:4px solid #ffbb00;
 padding:10px;
 border-radius:6px;
 font-size:14px;
 margin-top:8px;
}
</style>
</head>

<body>

<div class="card">
  <h3 id="name"></h3>
  <p id="username"></p>
  <p id="userid"></p>
</div>

<div class="card">
  <h2 id="ngnBal">‚Ç¶0</h2>
  <p id="usdBal">‚âà $0</p>
</div>

<div class="card">
  <button class="withdraw" onclick="openWithdraw()">Withdraw</button>
  <button class="sell" onclick="location.href='index.html'">Sell Products</button>
</div>

<div class="card hidden" id="withdrawBox">
  <select id="method" onchange="switchMethod()">
    <option value="">Select method</option>
    <option value="bank">Bank Transfer (NGN)</option>
    <option value="bnb">Crypto (BNB BEP20)</option>
  </select>

  <div id="bankBox" class="hidden">
    <input id="bankAmount" placeholder="Amount NGN">
    <input id="bankNumber" placeholder="Account Number">
    <input id="bankName" placeholder="Bank Name">
    <input id="bankHolder" placeholder="Account Name">
    <button class="withdraw" onclick="submitBank()">Submit</button>
  </div>

  <div id="bnbBox" class="hidden">
    <input id="bnbAddress" placeholder="BNB BEP20 Address">
    <input id="bnbAmount" placeholder="Amount USD">
    <button class="withdraw" onclick="submitBNB()">Submit</button>
  </div>
</div>

<div class="card">
  <h3>‚è≥ Pending Withdrawals</h3>
  <div id="pendingList">No pending withdrawals</div>
</div>

<div id="msgBox"></div>

<div id="popup">
  <div id="popupContent" class="popup-content"></div>
</div>

<!-- MONETAG -->
<script src="//libtl.com/sdk.js" data-zone="9830606" data-sdk="show_9830606"></script>

<script>
// =====================
// TELEGRAM INIT
// =====================
Telegram.WebApp.ready();
Telegram.WebApp.expand();
const tgUser = Telegram.WebApp.initDataUnsafe.user || {};

// =====================
// LIVE RATE
// =====================
let rate = 1500;
fetch("https://open.er-api.com/v6/latest/USD")
.then(r=>r.json()).then(d=>rate=d.rates.NGN).catch(()=>{});

// =====================
// USER INFO
// =====================
name.textContent = tgUser.first_name+" "+(tgUser.last_name||"");
username.textContent = tgUser.username ? "@"+tgUser.username : "";
userid.textContent = "Telegram ID: "+tgUser.id;

// =====================
// BALANCE
// =====================
let balNGN = walletBalances[tgUser.id] || 0;
const STORE_KEY = "withdrawals_"+tgUser.id;
let withdrawals = JSON.parse(localStorage.getItem(STORE_KEY)) || [];

function pendingTotal(){
 return withdrawals.reduce((s,w)=>s+w.amountNGN,0);
}

function availableBalance(){
 return balNGN - pendingTotal();
}

function updateBalance(){
 let avail = availableBalance();
 ngnBal.textContent = "‚Ç¶"+avail.toLocaleString();
 usdBal.textContent = "‚âà $"+(avail/rate).toFixed(2);
}
updateBalance();

// =====================
// SHOW PENDING
// =====================
function renderPending(){
 if(withdrawals.length===0){
  pendingList.innerHTML="No pending withdrawals";
  return;
 }
 pendingList.innerHTML="";
 withdrawals.forEach(w=>{
  const d=document.createElement("div");
  d.className="pending";
  d.innerHTML=`
   <b>${w.method}</b><br>
   Amount: ‚Ç¶${w.amountNGN.toLocaleString()}<br>
   Status: ${w.status}<br>
   Date: ${new Date(w.date).toLocaleString()}
  `;
  pendingList.appendChild(d);
 });
}
renderPending();

// =====================
// UI HELPERS
// =====================
function showPopup(msg,type){
 popupContent.className="popup-content "+(type==="success"?"popup-success":"popup-error");
 popupContent.innerHTML=msg;
 popup.style.display="flex";
 popup.onclick=()=>popup.style.display="none";
}

function openWithdraw(){ withdrawBox.classList.remove("hidden"); }
function switchMethod(){
 bankBox.classList.add("hidden"); bnbBox.classList.add("hidden");
 if(method.value==="bank") bankBox.classList.remove("hidden");
 if(method.value==="bnb") bnbBox.classList.remove("hidden");
}

// =====================
// TELEGRAM BOT
// =====================
const BOT="7514817340:AAHUpE5ZPEUZkkM4rq4smoV_nzWfmwWBVGc";
const ADMIN="8140042906";
function sendTG(id,msg){
 fetch(`https://api.telegram.org/bot${BOT}/sendMessage`,{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({chat_id:id,text:msg,parse_mode:"HTML"})
 });
}

// =====================
// BANK WITHDRAW
// =====================
function submitBank(){
 let amt=Number(bankAmount.value);
 if(amt<5000) return showPopup("Minimum ‚Ç¶5,000","error");
 if(amt>availableBalance()) return showPopup("Insufficient balance","error");

 withdrawals.push({
  id:"WD-"+Date.now(),
  method:"BANK",
  amountNGN:amt,
  status:"PENDING",
  date:new Date().toISOString()
 });

 localStorage.setItem(STORE_KEY,JSON.stringify(withdrawals));

 sendTG(ADMIN,`<b>Withdrawal Request</b>
 Name: ${name.textContent}
 Username: ${username.textContent}
 ID: ${tgUser.id}
 Amount: ‚Ç¶${amt}`);

 sendTG(tgUser.id,`Your withdrawal of ‚Ç¶${amt} is PENDING.
Processing may take up to 24 hours.
Admin WhatsApp üëâ 2348121697423`);

 updateBalance();
 renderPending();
 showPopup("Withdrawal submitted successfully","success");
}

// =====================
// BNB WITHDRAW
// =====================
function submitBNB(){
 let usd=Number(bnbAmount.value);
 let ngn=usd*rate;
 if(usd<20) return showPopup("Minimum $20","error");
 if(ngn>availableBalance()) return showPopup("Insufficient balance","error");

 withdrawals.push({
  id:"WD-"+Date.now(),
  method:"BNB",
  amountNGN:Math.round(ngn),
  status:"PENDING",
  date:new Date().toISOString()
 });

 localStorage.setItem(STORE_KEY,JSON.stringify(withdrawals));

 sendTG(ADMIN,`<b>Withdrawal Request</b>
 Name: ${name.textContent}
 Username: ${username.textContent}
 ID: ${tgUser.id}
 Amount: $${usd}`);

 sendTG(tgUser.id,`Your withdrawal of $${usd} is PENDING.
Processing may take up to 24 hours.
Admin WhatsApp üëâ 2348121697423`);

 updateBalance();
 renderPending();
 showPopup("Withdrawal submitted successfully","success");
}

// =====================
// ADS
// =====================
function showAd(){ if(typeof show_9830606==="function") show_9830606(); }
setTimeout(()=>{ showAd(); setInterval(showAd,50000); },10000);
</script>
</body>
</html>