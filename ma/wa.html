<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Wallet ‚Äî Intelligent Marketplace</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="balance.js"></script>

<style>
  body{
    font-family: Arial, sans-serif;
    background:#f4f6f8;
    color:#111;
    padding:20px;
    margin:0;
  }

  /* Header */
  .header-wrap{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
  h2{margin:0;font-size:20px;}
  #themeToggle{
    padding:8px 12px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    font-size:16px;
    background:#000;
    color:#fff;
    width :50px;
  }

  /* Cards */
  .card{
    background:#fff;
    padding:18px;
    border-radius:14px;
    box-shadow:0 6px 18px rgba(0,0,0,.12);
    margin-bottom:14px;
    overflow:hidden;
  }

  /* User info */
  #userInfo{display:flex;align-items:center;gap:12px;}
  #profilePic{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#eee;}
  #name{font-size:18px;font-weight:bold;margin:0;}
  #username,#userid{margin:4px 0 0 0;color:#444;font-size:14px;}

  /* Balance */
  .bal-big{font-size:34px;font-weight:900;margin:2px 0 0 0;}
  .bal-sub{margin:6px 0 0 0;color:#555;font-weight:bold;}
  .bal-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
  .pill{
    padding:8px 10px;
    border-radius:10px;
    background:#eefaff;
    border:1px solid #8ed0ff;
    font-weight:bold;
    font-size:14px;
  }

  /* Buttons */
  button{
    width:100%;
    padding:16px;
    font-size:18px;
    font-weight:bold;
    border:none;
    border-radius:10px;
    cursor:pointer;
    margin-top:10px;
    transition:transform .15s ease, box-shadow .15s ease;
  }
  button:active{transform:scale(.98);box-shadow:0 3px 10px rgba(0,0,0,.2) inset;}
  .sell{background:#1a73e8;color:#fff;}
  .withdraw{background:#28a745;color:#fff;}
  .ghost{background:#444;color:#fff;}

  input,select{
    width:100%;
    padding:12px;
    margin-top:10px;
    border-radius:8px;
    border:1px solid #ccc;
    outline:none;
  }

  .hidden{display:none;}

  /* Message box */
  #msgBox{
    display:none;
    padding:12px;
    border-radius:8px;
    font-weight:bold;
    text-align:center;
    font-size:16px;
    position:fixed;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    z-index:9999;
    min-width:300px;
    max-width:90%;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
    cursor:pointer;
  }

  /* Popup */
  #popup{
    display:none;
    position:fixed;top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,.6);
    justify-content:center;
    align-items:center;
    z-index:99999;
    padding:16px;
  }
  .popup-content{
    background:#fff;
    padding:25px;
    width:100%;
    max-width:420px;
    border-radius:12px;
    text-align:center;
    font-size:16px;
    font-weight:bold;
    box-shadow:0 5px 18px rgba(0,0,0,0.3);
    animation: popIn 0.25s ease-out;
  }
  @keyframes popIn {
    from { transform: scale(0.7); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  .popup-success{border:2px solid #28a745;color:#155724;background:#d4edda;}
  .popup-error{border:2px solid #dc3545;color:#721c24;background:#f8d7da;}

  /* Pending list */
  .pending-item{
    background:#fff4ce;
    border-left:4px solid #ffbb00;
    padding:10px;
    border-radius:8px;
    margin-top:10px;
    font-size:14px;
    font-weight:bold;
    color:#6b5200;
  }
  .pending-item.success{
    background:#d4edda;
    border-left-color:#28a745;
    color:#155724;
  }
  .muted{font-size:12px;font-weight:bold;opacity:.85;margin-top:6px;}

  /* Dark theme */
  body.dark{background:#0f1113;color:#e6eef8;transition: background .25s, color .25s;}
  body.dark .card{background:#151719;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
  body.dark #username, body.dark #userid, body.dark .bal-sub{color:#c9d4e4;}
  body.dark .pill{background:#0f1720;border:1px solid #264653;color:#e6eef8;}
  body.dark input, body.dark select{background:#0b0d0f;color:#e6eef8;border:1px solid #2b2f33;}
  body.dark #themeToggle{background:#fff;color:#000;}
  body.dark .popup-content{background:#101214;color:#e6eef8;border:1px solid #222;}
</style>
</head>

<body>

<div class="header-wrap">
  <h2>Intelligent Marketplace ‚Äî Wallet</h2>
  <button id="themeToggle" aria-label="Toggle theme">üåô</button>
</div>

<!-- USER INFO -->
<div class="card" id="userInfo">
  <img id="profilePic" src="https://via.placeholder.com/64" alt="Profile">
  <div>
    <p id="name"></p>
    <p id="username"></p>
    <p id="userid"></p>
  </div>
</div>

<!-- BALANCE -->
<div class="card">
  <div style="font-weight:bold;opacity:.9;">Available Balance</div>
  <div class="bal-big" id="ngnBal">‚Ç¶0</div>
  <div class="bal-sub" id="usdBal">‚âà $0.00</div>

  <div class="bal-row">
    <div class="pill" id="pillBase">Base: ‚Ç¶0</div>
    <div class="pill" id="pillPending">Pending: ‚Ç¶0</div>
  </div>

  <div class="muted">Minimum withdrawal: ‚Ç¶5,000 (Bank) or $20 (BNB). $1 fee applies.</div>
</div>

<!-- ACTIONS -->
<div class="card">
  <button class="withdraw" onclick="openWithdraw()">Withdraw</button>
  <button class="sell" onclick="location.href='index.html'">Sell Products</button>
</div>

<!-- WITHDRAW FORM -->
<div class="card hidden" id="withdrawBox">
  <div style="font-weight:bold;margin-bottom:6px;">Request Withdrawal</div>

  <select id="method" onchange="switchMethod()">
    <option value="">Select method</option>
    <option value="bank">Bank Transfer (NGN)</option>
    <option value="bnb">Crypto (BNB BEP20)</option>
  </select>

  <!-- BANK -->
  <div id="bankBox" class="hidden">
    <input id="bankAmount" placeholder="Amount (NGN)">
    <input id="bankNumber" placeholder="Account Number">
    <input id="bankName" placeholder="Bank Name">
    <input id="bankHolder" placeholder="Account Name">
    <button class="withdraw" onclick="submitBank()">Submit</button>
  </div>

  <!-- BNB -->
  <div id="bnbBox" class="hidden">
    <input id="bnbAddress" placeholder="BNB (Smart Chain) BEP20 Address">
    <input id="bnbAmount" placeholder="Amount ($)">
    <button class="withdraw" onclick="submitBNB()">Submit</button>
  </div>

  <button class="ghost" onclick="closeWithdraw()">Close</button>
</div>

<!-- PENDING LIST -->
<div class="card">
  <div style="font-weight:bold;">‚è≥ Withdrawal History</div>
  <div class="muted">Stored on this phone only (local storage).</div>
  <div id="pendingList" style="margin-top:10px;">No withdrawal history yet.</div>
</div>

<!-- MESSAGE BOX -->
<div id="msgBox"></div>

<!-- POPUP -->
<div id="popup">
  <div id="popupContent" class="popup-content"></div>
</div>

<!-- MONETAG -->
<script src="//libtl.com/sdk.js" data-zone="9830606" data-sdk="show_9830606"></script>

<script>
/* ===============================
   TELEGRAM INIT
================================ */
Telegram.WebApp.ready();
Telegram.WebApp.expand();
const tgUser = Telegram.WebApp.initDataUnsafe.user || {};

/* ===============================
   LIVE USD -> NGN RATE
================================ */
let rate = 1500;
async function fetchLiveRate(){
  try{
    const res = await fetch("https://open.er-api.com/v6/latest/USD");
    const data = await res.json();
    rate = data.rates.NGN || 1500;
  }catch(e){
    rate = 1500;
  }
}
fetchLiveRate();

/* ===============================
   THEME: auto + manual override
================================ */
(function(){
  const toggleBtn = document.getElementById('themeToggle');
  const userPref = localStorage.getItem('site-theme'); // "dark" or "light" or null

  function applyTheme(theme){
    if(theme === 'dark'){
      document.body.classList.add('dark');
      toggleBtn.textContent = '‚òÄÔ∏è';
      toggleBtn.setAttribute('aria-pressed','true');
    } else {
      document.body.classList.remove('dark');
      toggleBtn.textContent = 'üåô';
      toggleBtn.setAttribute('aria-pressed','false');
    }
  }

  if(userPref === 'dark' || userPref === 'light'){
    applyTheme(userPref);
  } else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
    applyTheme('dark');
  } else {
    applyTheme('light');
  }

  toggleBtn.addEventListener('click', () => {
    const nowDark = document.body.classList.toggle('dark');
    applyTheme(nowDark ? 'dark' : 'light');
    try { localStorage.setItem('site-theme', nowDark ? 'dark' : 'light'); } catch(e){}
  });
})();

/* ===============================
   USER INFO (modern)
================================ */
const fullName = (tgUser.first_name || "") + (tgUser.last_name ? (" " + tgUser.last_name) : "");
document.getElementById("name").textContent = fullName.trim() || "Telegram User";
document.getElementById("username").textContent = tgUser.username ? ("@" + tgUser.username) : "No username";
document.getElementById("userid").textContent = "Telegram ID: " + (tgUser.id || "Unknown");
if(tgUser.photo_url) document.getElementById("profilePic").src = tgUser.photo_url;

/* ===============================
   MESSAGE + POPUP (same style)
================================ */
function showMessage(message, type="success") {
  const box = document.getElementById('msgBox');
  box.style.color = type==="success" ? "#155724" : "#721c24";
  box.style.background = type==="success" ? "#d4edda" : "#f8d7da";
  box.style.border = type==="success" ? "1px solid #c3e6cb" : "1px solid #f5c6cb";
  box.textContent = message;
  box.style.display = "block";
  box.onclick = () => { box.style.display = "none"; };
  setTimeout(()=>{ box.style.display="none"; }, 4500);
}

function showPopup(message, type="success"){
  const popup = document.getElementById("popup");
  const content = document.getElementById("popupContent");
  content.innerHTML = message;
  content.className = "popup-content " + (type==="success" ? "popup-success" : "popup-error");
  popup.style.display = "flex";
  popup.onclick = () => { popup.style.display = "none"; };
}

/* ===============================
   BALANCE + LOCAL WITHDRAWALS
================================ */
let balNGN = (window.walletBalances && tgUser.id) ? (walletBalances[tgUser.id] || 0) : 0;

const STORE_KEY = "withdrawals_" + (tgUser.id || "0");
let withdrawals = [];
try {
  withdrawals = JSON.parse(localStorage.getItem(STORE_KEY)) || [];
} catch(e){
  withdrawals = [];
}

function pendingTotal(){
  return withdrawals.reduce((sum,w)=> sum + (Number(w.amountNGN)||0), 0);
}

function availableBalance(){
  return balNGN - pendingTotal();
}

function updateBalanceUI(){
  const avail = Math.max(0, availableBalance());
  document.getElementById("ngnBal").textContent = "‚Ç¶" + Math.round(avail).toLocaleString();
  document.getElementById("usdBal").textContent = "‚âà $" + (avail / rate).toFixed(2);

  document.getElementById("pillBase").textContent = "Base: ‚Ç¶" + Math.round(balNGN).toLocaleString();
  document.getElementById("pillPending").textContent = "Pending: ‚Ç¶" + Math.round(pendingTotal()).toLocaleString();
}

/* Mark pending as SUCCESS when admin changes balance on GitHub */
function syncWithAdminBalanceSuccess(){
  const pending = pendingTotal();
  if (pending > 0 && pending > balNGN) {
    withdrawals = withdrawals.map(w => {
      if (w.status === "PENDING") {
        return { ...w, status:"SUCCESS", approvedAt: new Date().toISOString() };
      }
      return w;
    });
    localStorage.setItem(STORE_KEY, JSON.stringify(withdrawals));
    showMessage("Withdrawal marked as SUCCESS (synced with admin balance).","success");
  }
}

function renderHistory(){
  const list = document.getElementById("pendingList");
  if(!withdrawals.length){
    list.innerHTML = "No withdrawal history yet.";
    return;
  }
  list.innerHTML = "";
  withdrawals
    .slice()
    .reverse()
    .forEach(w=>{
      const div = document.createElement("div");
      div.className = "pending-item" + (w.status==="SUCCESS" ? " success" : "");
      const when = w.date ? new Date(w.date).toLocaleString() : "";
      const extra = (w.method==="BNB" && w.amountUSD) ? ` ($${w.amountUSD})` : "";
      const approved = w.approvedAt ? `<div class="muted">Approved: ${new Date(w.approvedAt).toLocaleString()}</div>` : "";
      div.innerHTML = `
        Method: ${w.method}<br>
        Amount: ‚Ç¶${Math.round(w.amountNGN).toLocaleString()}${extra}<br>
        Status: <b>${w.status}</b><br>
        <span class="muted">Date: ${when}</span>
        ${approved}
      `;
      list.appendChild(div);
    });
}

/* refresh UI */
function refreshAll(){
  updateBalanceUI();
  renderHistory();
}

/* ===============================
   WITHDRAW UI
================================ */
function openWithdraw(){ document.getElementById("withdrawBox").classList.remove("hidden"); }
function closeWithdraw(){ document.getElementById("withdrawBox").classList.add("hidden"); }

function switchMethod(){
  document.getElementById("bankBox").classList.add("hidden");
  document.getElementById("bnbBox").classList.add("hidden");
  if(method.value==="bank") document.getElementById("bankBox").classList.remove("hidden");
  if(method.value==="bnb") document.getElementById("bnbBox").classList.remove("hidden");
}

/* ===============================
   TELEGRAM BOT (same as your code)
================================ */
const BOT_TOKEN="7514817340:AAHUpE5ZPEUZkkM4rq4smoV_nzWfmwWBVGc";
const ADMIN_ID="8140042906";

function sendTelegramMessage(chatId, message){
  fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ chat_id: chatId, text: message, parse_mode:"HTML" })
  });
}

/* ===============================
   WITHDRAW ACTIONS (store locally + include available balance)
================================ */

/* BANK */
async function submitBank(){
  const amt = Number(document.getElementById("bankAmount").value);
  const acct = document.getElementById("bankNumber").value.trim();
  const bname = document.getElementById("bankName").value.trim();
  const holder = document.getElementById("bankHolder").value.trim();

  if(!amt || isNaN(amt)) return showPopup("Enter a valid amount.","error");
  if(amt < 5000) return showPopup("Minimum withdrawal ‚Ç¶5,000","error");

  const avail = availableBalance();
  if(amt > avail) return showPopup("Insufficient balance","error");

  if(!acct || acct.length < 6) return showPopup("Enter a valid account number.","error");
  if(!bname) return showPopup("Enter bank name.","error");
  if(!holder) return showPopup("Enter account name.","error");

  // Save locally (PENDING) and lock instantly
  const record = {
    id: "WD-" + Date.now(),
    method: "BANK",
    amountNGN: Math.round(amt),
    status: "PENDING",
    date: new Date().toISOString(),
    details:{ account:acct, bank:bname, name:holder }
  };
  withdrawals.push(record);
  localStorage.setItem(STORE_KEY, JSON.stringify(withdrawals));

  // Message admin (include available balance)
  const msgAdmin = `
<b>üí∏ Withdrawal Request</b>

<b>USER</b>
‚Ä¢ Name: ${fullName}
‚Ä¢ Username: ${tgUser.username ? "@"+tgUser.username : "Not set"}
‚Ä¢ Telegram ID: ${tgUser.id}

<b>WITHDRAW</b>
‚Ä¢ Method: Bank Transfer
‚Ä¢ Amount: ‚Ç¶${Math.round(amt).toLocaleString()}
‚Ä¢ Available Balance (before lock): ‚Ç¶${Math.round(avail).toLocaleString()}
‚Ä¢ Pending Total (after lock): ‚Ç¶${Math.round(pendingTotal()).toLocaleString()}

<b>BANK DETAILS</b>
‚Ä¢ Account No: ${acct}
‚Ä¢ Bank: ${bname}
‚Ä¢ Account Name: ${holder}
`;
  sendTelegramMessage(ADMIN_ID, msgAdmin);

  // Message user
  const msgUser = `Your withdrawal request of ‚Ç¶${Math.round(amt).toLocaleString()} has been sent to the administrator.
It might take up to 24 hours. Please be patient.

Admin WhatsApp Incase you need help üëâ 2348121697423`;
  sendTelegramMessage(tgUser.id, msgUser);

  refreshAll();
  showPopup("Withdrawal request sent successfully ‚úÖ<br><br>Your balance has been locked until admin verifies.","success");
}

/* BNB */
async function submitBNB(){
  if(rate === 0) await fetchLiveRate();

  const addr = document.getElementById("bnbAddress").value.trim();
  const amtUSD = Number(document.getElementById("bnbAmount").value);

  if(!addr || addr.length < 10) return showPopup("Enter a valid BNB (BEP20) address.","error");
  if(!amtUSD || isNaN(amtUSD)) return showPopup("Enter a valid amount.","error");
  if(amtUSD < 20) return showPopup("Minimum withdrawal $20","error");

  const amtNGN = amtUSD * rate;
  const avail = availableBalance();
  if(amtNGN > avail) return showPopup("Insufficient balance","error");

  const record = {
    id: "WD-" + Date.now(),
    method: "BNB",
    amountNGN: Math.round(amtNGN),
    amountUSD: Number(amtUSD.toFixed(2)),
    status: "PENDING",
    date: new Date().toISOString(),
    details:{ address: addr }
  };
  withdrawals.push(record);
  localStorage.setItem(STORE_KEY, JSON.stringify(withdrawals));

  const msgAdmin = `
<b>üí∏ Withdrawal Request</b>

<b>USER</b>
‚Ä¢ Name: ${fullName}
‚Ä¢ Username: ${tgUser.username ? "@"+tgUser.username : "Not set"}
‚Ä¢ Telegram ID: ${tgUser.id}

<b>WITHDRAW</b>
‚Ä¢ Method: BNB (BEP20)
‚Ä¢ Amount: $${amtUSD.toFixed(2)} (‚âà ‚Ç¶${Math.round(amtNGN).toLocaleString()})
‚Ä¢ Available Balance (before lock): ‚Ç¶${Math.round(avail).toLocaleString()}
‚Ä¢ Pending Total (after lock): ‚Ç¶${Math.round(pendingTotal()).toLocaleString()}

<b>BNB DETAILS</b>
‚Ä¢ Address: ${addr}
‚Ä¢ Network: BNB Smart Chain (BEP20)
`;
  sendTelegramMessage(ADMIN_ID, msgAdmin);

  const msgUser = `Your withdrawal request of $${amtUSD.toFixed(2)} has been sent to the administrator.
It might take up to 24 hours. Please be patient.

Admin WhatsApp Incase you need help üëâ 2348121697423`;
  sendTelegramMessage(tgUser.id, msgUser);

  refreshAll();
  showPopup("Withdrawal request sent successfully ‚úÖ<br><br>Your balance has been locked until admin verifies.","success");
}

/* ===============================
   ADS (10s then every 50s)
================================ */
function showAd(){
  if(typeof show_9830606==="function"){ show_9830606(); }
  else { setTimeout(showAd, 500); }
}
window.addEventListener("load", () => {
  setTimeout(() => { showAd(); setInterval(showAd, 50000); }, 10000);
});

/* ===============================
   INITIAL SYNC + UI
================================ */
syncWithAdminBalanceSuccess();
refreshAll();

/* Recompute USD display once rate loads */
setTimeout(()=>{ refreshAll(); }, 1200);
</script>

</body>
</html>